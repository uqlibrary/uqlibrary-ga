<link rel="import" href="elements.html">

<!--

Custom web element for Google Analytics

Example:

    <uqlibrary-ga traking-id='UA-1234-5' website-url='http://www.test.com/app' app-name='TestApp' cookie-domain='test.com'></uqlibrary-ga>

@demo

@demo demo/index.html

-->

<dom-module id="uqlibrary-ga">

  <script>

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    Polymer({

      is: 'uqlibrary-ga',

      properties: {

        /** The `appName` application name to prefix page views
         *
         */
        appName: {
          type: String,
          value: 'UQLAPP'
        },

        /**
         * The `trackingId` Google Analytics tracking ID
         *
         */
        trackingId: {
          type: String,
          value: '<GA-TRACKING-ID>'
        },

        /** The `websiteUrl` url of website for Google Analytics
         *
         */
        websiteUrl: {
          type: String,
          value: '<GA-WEBSITE-URL>'
        },

        /** The `cookieDomain` set domain for cookies
         *
         */
        cookieDomain: {
          type: String,
          value: '<GA-COOKIE-DOMAIN>'
        },

        /** Google Analytics setting 'siteSpeedSampleRate'
        *
        */
        sampleRate: {
          type: Number,
          value: 100
        },

        /** Tracking ID for testing purposes. It isn't passed to GA
         *
         */
        disableTracking: {
          type: String,
          value: 'ga-disable-UA-XXX-Y'
        },

        /** Defines whether the element works in test mode and uses mock data
         *
         */
        useMockData: {
          type: Boolean,
          value: false
        }

      },

      ready: function() {
        var cookie = this.getCookie('UQLMockData');
        this.useMockData = false;
        if (cookie !== "undefined") {
          this.useMockData = (cookie === 'enabled');
        }
        //Don't use GA if we are running a mock data test
        if (!this.useMockData) {
          try {
            ga('create', this.trackingId,
                    {
                      'cookieName': 'ga_' + this.appName,
                      'cookieDomain': document.location.hostname.indexOf(this.cookieDomain) >= 0 ? this.cookieDomain : 'none',
                      'sampleRate': this.sampleRate
                    });
          } catch(err){}
        }

        //check if user opted out from GA tracking or if we are currently using mock testing
        this.disableTracking = 'ga-disable-' + this.trackingId;
        if (document.cookie.indexOf(this.disableTracking + '=true') > -1) {
          window[this.disableTracking] = true;
        }
      },

      /**
       *  The `optOut` method disables google analytics tracking and sets cookie to remember this setting
       *
       * @method optOut
       */
      optOut : function() {
          document.cookie = this.disableTracking + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
          window[this.disableTracking] = true;
      },

      /**
       *  The `addPageView` method sets current page and records a page view.
       *  Page view is recorded as '/AppName/page'
       *
       * @method addPageView
       */
      addPageView: function(page) {
        //Don't use GA if we are running a mock data test
        if (!this.useMockData) {
          try {
            var pageHit = "/" + this.appName + "/" + page;

            ga('set', {page: pageHit, title: pageHit});
            ga('send', 'pageview');
          } catch (err) {
          }
        }
      },

      /**
       *  The `addEvent` method records an action of the event
       *  Event is recorded with category set to 'AppName' and action set to '/AppName/action'
       *
       * @method addEvent
       */
      addEvent: function(action, label) {
        //Don't use GA if we are running a mock data test
        if (!this.useMockData) {
          try {
            if (typeof(label) != 'undefined') {
              ga('send', 'event', this.appName, "/" + this.appName + "/" + action, label);
            }
            else {
              ga('send', 'event', this.appName, "/" + this.appName + "/" + action);
            }
          } catch (err) {
          }
        }
      },

      /**
       * Gets a cookie by name
       * @param name the name of the cookie to return
       * @returns {String}
       */
      getCookie: function (name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

    });

  </script>

</dom-module>
