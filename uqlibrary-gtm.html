<link rel="import" href="elements.html">

<!--

Custom web element for Google Tag Manager

Example:

    <uqlibrary-gtm container-id='GTM-1234-5' app-name='TestApp'></uqlibrary-gtm>

@demo

@demo demo/index.html

-->

<dom-module id="uqlibrary-gtm">

  <template>
    <noscript>
      <iframe src="//www.googletagmanager.com/ns.html?id={{containerId}}" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
  </template>

  <script>

    Polymer({

      is: 'uqlibrary-gtm',

      properties: {

        /**
         * The `appName` application name to prefix page views
         */
        appName: {
          type: String,
          value: 'UQLAPP'
        },

        /**
         * The `containerId` Google Tag Manager container ID
         */
        containerId: {
          type: String,
          value: '<GTM-CONTAINER-ID>'
        },

        /**
         * Defines whether the element works in test mode and uses mock data
         */
        useMockData: {
          type: Boolean,
          value: false
        },

        /**
         * User's ptype if the user is logged in
         */
        ptype: {
          type: String
        }
      },

      attached: function() {
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',this.containerId);
      },

      ready: function() {
        var cookie = this.getCookie('UQLMockData'),
            ptype = this.getCookie('UQLID_PTYPE');

        this.useMockData = false;
        if (cookie) {
          this.useMockData = (cookie === 'enabled');
        }

        this.ptype = null;
        if (ptype) {
          this.ptype = ptype;
        }
      },

      /**
       * The `addEvent` method records an action of the event
       * Event is recorded with category set to 'AppName' and action set to '/AppName/action'
       *
       * @method addEvent
       * @param action
       * @param label
       */
      addEvent: function(action, label) {
        if (!this.useMockData){

          var data = {
            'event':'Click',
            'category': this.appName,
            'action': this.appName + "/" + action,
            'label': label
          }

          if (this.ptype) {
            data.dimension1 = this.ptype;
          }

          try {
            dataLayer.push(data);
          } catch (err) {
          }
        }
      },

      /**
       * Gets a cookie by name
       * @param name the name of the cookie to return
       * @returns {String}
       */
      getCookie: function (name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

    });

  </script>

</dom-module>
